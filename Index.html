<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>WMoldes | Painel de Controle</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<style>
    /* ========== VARIÁVEIS DE CORES ========== */
    :root {
      /* Cores modo claro */
      --bg: #f8fafc;
      --text: #334155;
      --card: #ffffff;
      --primary: #0ea5e9;
      --primary-light: #e0f2fe;
      --accent: #1e293b;
      --accent-light: #f1f5f9;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      --error: #ef4444;
      --border: #e2e8f0;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s ease;
      --font-main: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
      
      /* Gradiente para o fundo */
      --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
    }

    /* Variáveis para modo escuro */
    body.dark-mode {
      --bg: #121826;
      --text: #e2e8f0;
      --card: #1e293b;
      --primary: #38bdf8;
      --primary-light: #0c4a6e;
      --accent: #f1f5f9;
      --accent-light: #1e293b;
      --border: #334155;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.25);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.3);
      --bg-gradient: linear-gradient(135deg, #0c4a6e 0%, #1e3a8a 100%);
    }

    /* ========== ESTILOS GERAIS ========== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      padding: 0;
      font-family: var(--font-main);
      background-color: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      line-height: 1.6;
      background: var(--bg-gradient);
      transition: background-color 0.5s ease, color 0.5s ease;
    }
    
    .container {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2, h3 {
      color: var(--accent);
      margin: 0 0 15px 0;
      font-weight: 600;
    }
    
    h1 {
      font-size: 2.2rem;
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      position: relative;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    h1:after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60px;
      height: 3px;
      background: var(--primary);
      border-radius: 2px;
    }
    
    h2 {
      font-size: 1.5rem;
      margin-top: 30px;
      margin-bottom: 20px;
      padding-left: 12px;
      border-left: 3px solid var(--primary);
    }

    /* ========== LOGIN SCREEN ========== */
    .login-container {
      max-width: 420px;
      width: 90%;
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      padding: 40px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
      z-index: 10;
      transform: translateY(0);
      transition: transform 0.4s ease, box-shadow 0.4s ease;
      border: 1px solid rgba(14, 165, 233, 0.15);
    }
    
    .login-container:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .login-icon {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }
    
    .login-container:hover .login-icon {
      transform: scale(1.1);
    }
    
    .login-title {
      font-size: 1.7rem;
      margin-bottom: 8px;
      color: var(--accent);
    }
    
    .login-subtitle {
      color: #94a3b8;
      margin-bottom: 30px;
      font-size: 1.05rem;
    }
    
    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .input-group {
      position: relative;
    }
    
    .input-group i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      font-size: 1.1rem;
      transition: color 0.3s;
    }
    
    .login-input {
      padding: 14px 14px 14px 45px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      width: 100%;
      font-size: 1rem;
      transition: var(--transition);
      background: var(--bg);
      font-family: inherit;
      color: var(--text);
    }
    
    .login-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
      background: var(--card);
    }
    
    .login-input:focus + i {
      color: var(--primary);
    }
    
    .login-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: var(--shadow-sm);
      font-size: 1rem;
      font-family: inherit;
      margin-top: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .login-btn:hover {
      background: #0284c7;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .login-btn:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    .login-btn:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    .error-message {
      color: var(--error);
      margin-top: 5px;
      text-align: left;
      font-size: 0.85rem;
      display: none;
      animation: shake 0.5s;
    }

    /* ========== BARRA SUPERIOR ========== */
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
      margin-bottom: 25px;
      background: var(--card);
      padding: 18px 25px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      position: relative;
      z-index: 2;
    }
    
    .search-container {
      position: relative;
      flex-grow: 1;
      max-width: 400px;
    }
    
    .search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
      font-size: 1rem;
      transition: color 0.3s;
    }
    
    .top-bar input {
      padding: 12px 12px 12px 42px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      width: 100%;
      font-size: 1rem;
      transition: var(--transition);
      background: var(--bg);
      font-family: inherit;
      color: var(--text);
    }
    
    .top-bar input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
      background: var(--card);
    }
    
    .top-bar input:focus + i {
      color: var(--primary);
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .top-bar button {
      background: var(--card);
      color: var(--accent);
      border: 1px solid var(--border);
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow-sm);
      font-size: 0.95rem;
      font-family: inherit;
      position: relative;
      overflow: hidden;
    }
    
    .top-bar button:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .top-bar button:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    .top-bar button:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    .top-bar button.primary {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .top-bar button.criticos {
      background: var(--error);
      color: white;
      border-color: var(--error);
    }
    
    .top-bar button.logout {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .top-bar button.pdf {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    
    .top-bar button.dark-mode-toggle {
      background: #4f46e5;
      color: white;
      border-color: #4f46e5;
    }

    /* ========== TABS ========== */
    .tabs-container {
      margin-bottom: 30px;
      background: var(--card);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      border: 1px solid var(--border);
      position: relative;
      z-index: 2;
    }
    
    .tabs-header {
      display: flex;
      background: var(--accent-light);
      border-bottom: 1px solid var(--border);
    }
    
    .tab-btn {
      padding: 16px 25px;
      background: transparent;
      border: none;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .tab-btn i {
      font-size: 1.1rem;
      color: var(--primary);
      transition: transform 0.3s;
    }
    
    .tab-btn:hover i {
      transform: scale(1.1);
    }
    
    .tab-btn.active {
      color: var(--primary);
      font-weight: 600;
      background: var(--card);
    }
    
    .tab-btn.active:after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--primary);
    }
    
    .tab-content {
      display: none;
      padding: 0;
    }
    
    .tab-content.active {
      display: block;
      padding: 25px;
      animation: fadeIn 0.4s ease;
    }

    /* ========== CARTÕES DE MÁQUINAS ========== */
    .maquinas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    
    .maquina {
      background: var(--card);
      border-radius: var(--radius-md);
      padding: 22px;
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
      transform: translateY(0);
    }
    
    .maquina:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-md);
    }
    
    .maquina.alerta {
      border-left: 4px solid var(--error);
      animation: pulse 2s infinite;
    }
    
    .maquina-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border);
    }
    
    .maquina-id {
      font-weight: 700;
      font-size: 1.3rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .prefixo-container {
      position: relative;
      min-width: 180px;
    }
    
    .prefixo-select {
      padding: 6px 30px 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--accent);
      font-weight: 500;
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      width: 100%;
      transition: var(--transition);
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 14px;
    }
    
    .prefixo-select:hover {
      border-color: var(--primary);
    }
    
    .prefixo-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.15);
    }
    
    /* Estilos para o dropdown personalizado */
    .custom-select {
      position: relative;
      width: 100%;
    }
    
    .select-selected {
      background-color: var(--card);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      padding: 10px 35px 10px 15px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    
    .select-selected:after {
      content: "";
      position: absolute;
      top: 50%;
      right: 15px;
      width: 0;
      height: 0;
      border: 6px solid transparent;
      border-color: var(--primary) transparent transparent transparent;
      transform: translateY(-50%);
    }
    
    .select-selected.select-arrow-active:after {
      border-color: transparent transparent var(--primary) transparent;
      top: 40%;
    }
    
    .select-items {
      position: absolute;
      background-color: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      top: 100%;
      left: 0;
      right: 0;
      z-index: 99;
      max-height: 250px;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      display: none;
    }
    
    .select-search-container {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--card);
      z-index: 2;
    }
    
    .select-search {
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 0.9rem;
    }
    
    .select-items div {
      padding: 10px 15px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background-color 0.2s;
    }
    
    .select-items div:last-child {
      border-bottom: none;
    }
    
    .select-items div:hover {
      background-color: var(--accent-light);
    }
    
    .select-items div.selected {
      background-color: var(--primary-light);
      color: var(--primary);
    }
    
    .select-hide {
      display: none;
    }
    
    .linha {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding: 12px 15px;
      border-radius: var(--radius-sm);
      transition: background 0.3s;
      background: var(--bg);
      border: 1px solid var(--border);
    }
    
    .linha:hover {
      background: var(--accent-light);
    }
    
    .controles {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .controles button {
      padding: 8px 14px;
      border: none;
      color: white;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
      min-width: 38px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: var(--shadow-sm);
      position: relative;
      overflow: hidden;
    }
    
    .controles button:hover {
      transform: scale(1.05);
    }
    
    .controles button:active {
      transform: scale(0.95);
    }
    
    .controles button:after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    .controles button:focus:not(:active)::after {
      animation: ripple 1s ease-out;
    }
    
    .controles span {
      min-width: 36px;
      text-align: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    
    /* Estilos específicos para cada tipo de peça */
    .molde-label { color: var(--accent); font-weight: 500; }
    .blank-label { color: var(--accent); font-weight: 500; }
    .neckring-label { color: var(--accent); font-weight: 500; }
    
    .molde-bg { background: var(--primary); }
    .blank-bg { background: #0c4a6e; }
    .neckring-bg { background: #4f46e5; }
    
    .reserva {
      background: rgba(241, 245, 249, 0.2);
      border-radius: var(--radius-sm);
      margin-top: 8px;
    }
    
    .reserva-label {
      font-size: 0.85rem;
      color: #94a3b8;
    }
    
    /* Novos estilos para os botões de múltipla seleção */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    
    .btn-group button {
      flex: 1;
      min-width: 30px;
      padding: 6px 8px;
      font-size: 0.8rem;
    }

    /* ========== TOTAIS E NOTIFICAÇÕES ========== */
    #totais {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .total-item {
      background: var(--card);
      padding: 22px 18px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      text-align: center;
      transition: var(--transition);
      border: 1px solid var(--border);
      transform: translateY(0);
    }
    
    .total-item:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    
    .total-title {
      font-size: 1.1rem;
      font-weight: 500;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: #94a3b8;
    }
    
    .total-valor {
      font-size: 2rem;
      font-weight: 700;
      margin: 8px 0;
      color: var(--accent);
    }
    
    .total-sub {
      font-size: 0.9rem;
      color: #94a3b8;
    }
    
    .alert-message {
      margin-top: 20px;
      padding: 12px 15px;
      background: #fffbeb;
      border-radius: var(--radius-sm);
      font-weight: 500;
      text-align: center;
      border: 1px solid #fcd34d;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      animation: fadeIn 0.5s;
      font-size: 0.95rem;
      color: #92400e;
    }

    /* ========== GRÁFICOS ========== */
    .graficos-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
      gap: 25px;
      margin-bottom: 10px;
    }
    
    .grafico-card {
      background: var(--card);
      padding: 25px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--border);
      transform: translateY(0);
    }
    
    .grafico-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }
    
    canvas {
      display: block;
      width: 100% !important;
      height: 300px !important;
    }

    /* ========== NOTIFICAÇÕES TOAST ========== */
    .toast {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: var(--accent);
      color: white;
      padding: 16px 24px;
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-lg);
      animation: fadein 0.4s, fadeout 0.4s 2.6s;
      z-index: 1000;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
      max-width: 400px;
      font-size: 1rem;
      border-left: 4px solid var(--primary);
      backdrop-filter: blur(10px);
    }
    
    .toast.error {
      border-left-color: var(--error);
    }
    
    .toast.warning {
      border-left-color: var(--warning);
    }
    
    .toast.info {
      border-left-color: var(--info);
    }
    
    .toast i {
      font-size: 1.4rem;
    }

    /* ========== BACKGROUND DECORATIVO ========== */
    .background-shapes {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }
    
    .shape {
      position: absolute;
      border-radius: 50%;
      opacity: 0.1;
    }
    
    .shape-1 {
      width: 300px;
      height: 300px;
      background: var(--primary);
      top: -100px;
      left: -100px;
    }
    
    .shape-2 {
      width: 200px;
      height: 200px;
      background: var(--info);
      bottom: -50px;
      right: -50px;
    }
    
    .shape-3 {
      width: 150px;
      height: 150px;
      background: var(--success);
      top: 50%;
      right: 10%;
    }

    /* ========== RESPONSIVIDADE ========== */
    @media (max-width: 1200px) {
      .graficos-container {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .top-bar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px;
      }
      
      .button-group {
        width: 100%;
        justify-content: center;
      }
      
      .maquinas-grid {
        grid-template-columns: 1fr;
      }
      
      .grafico-card {
        padding: 20px;
      }
      
      .tab-content.active {
        padding: 20px 15px;
      }
      
      .tab-btn {
        padding: 14px 18px;
        font-size: 0.95rem;
      }
      
      .maquina {
        padding: 20px;
      }
    }
    
    @media (max-width: 576px) {
      #totais {
        grid-template-columns: 1fr;
      }
      
      .graficos-container {
        gap: 20px;
      }
      
      .grafico-card {
        padding: 20px 15px;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .login-container {
        padding: 30px 20px;
      }
      
      .tab-btn {
        flex: 1;
        text-align: center;
        justify-content: center;
      }
    }

    /* ========== ANIMAÇÕES ========== */
    @keyframes highlight {
      0% { background-color: rgba(14, 165, 233, 0.2); }
      100% { background-color: transparent; }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadein {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes fadeout {
      from { opacity: 1; }
      to { opacity: 0; transform: translateY(20px); }
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.5;
      }
      100% {
        transform: scale(30, 30);
        opacity: 0;
      }
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
      100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .highlight {
      animation: highlight 1.5s ease;
    }
    
    /* ========== CONTEÚDO PRINCIPAL ========== */
    .main-content {
      display: none;
      width: 100%;
    }
    
    /* ========== PRELOADER ========== */
    .preloader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      transition: opacity 0.5s;
    }
    
    .preloader-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #f1f5f9;
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Modo escuro para preloader */
    body.dark-mode .preloader {
      background: rgba(18, 24, 38, 0.95);
    }
    
    body.dark-mode .preloader-spinner {
      border: 4px solid #1e293b;
      border-top: 4px solid var(--primary);
    }
</style>
</head>
<body>
<div class="background-shapes">
  <div class="shape shape-1"></div>
  <div class="shape shape-2"></div>
  <div class="shape shape-3"></div>
</div>

<div class="preloader" id="preloader">
  <div class="preloader-spinner"></div>
</div>

<!-- Tela de Login -->
<div class="login-container" id="loginScreen">
  <div class="login-icon">
    <i class="fas fa-industry"></i>
  </div>
  <h2 class="login-title">WMoldes | Painel de Controle</h2>
  <p class="login-subtitle">Sistema de gerenciamento de produção</p>
  
  <form class="login-form" id="loginForm">
    <div class="input-group">
      <i class="fas fa-key"></i>
      <input type="password" class="login-input" id="password" placeholder="Digite a senha de acesso" required>
    </div>
    <div class="error-message" id="errorMessage">
      <i class="fas fa-exclamation-circle"></i> Senha incorreta. Tente novamente.
    </div>
    <button type="submit" class="login-btn">
      <i class="fas fa-lock-open"></i> Acessar Sistema
    </button>
  </form>
</div>

<!-- Conteúdo Principal (inicialmente oculto) -->
<div class="container main-content" id="mainContent">
  <!-- 
    ====================================================
    CABEÇALHO
    ====================================================
  -->
  <header>
    <h1><i class="fas fa-industry"></i> Painel de Controle de Produção</h1>
    <p style="text-align: center; color: #94a3b8; margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto;">
      Monitoramento em tempo real da produção de moldes, blanks e neck rings
    </p>
  </header>

  <!-- 
    ====================================================
    BARRA DE CONTROLE SUPERIOR
    ====================================================
  -->
  <div class="top-bar">
    <div class="search-container">
      <i class="fas fa-search"></i>
      <input id="filtro" oninput="filtrar()" placeholder="Filtrar máquina (ex: A1)" type="text"/>
    </div>
    
    <div class="button-group">
      <button id="btnCriticos" onclick="alternarCriticos()">
        <i class="fas fa-exclamation-triangle"></i> Ver Críticos
      </button>
      
      <button class="primary" onclick="recarregarDados()">
        <i class="fas fa-sync-alt"></i> Atualizar
      </button>
      
      <button class="dark-mode-toggle" onclick="alternarModoEscuro()">
        <i class="fas fa-moon"></i> Modo Escuro
      </button>
      
      <button class="pdf" onclick="gerarPDF()">
        <i class="fas fa-file-pdf"></i> Gerar Relatório
      </button>
      
      <button class="logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </div>

  <!-- 
    ====================================================
    RESUMO DE TOTAIS
    ====================================================
  -->
  <div id="totais">
    <div class="total-item">
      <div class="total-title"><i class="fas fa-box"></i> Total Moldes</div>
      <div id="total-molde" class="total-valor">0</div>
      <div class="total-sub">em todas as máquinas</div>
    </div>
    
    <div class="total-item">
      <div class="total-title"><i class="fas fa-box"></i> Total Blanks</div>
      <div id="total-blank" class="total-valor">0</div>
      <div class="total-sub">em todas as máquinas</div>
    </div>
    
    <div class="total-item">
      <div class="total-title"><i class="fas fa-box"></i> Total Neck Rings</div>
      <div id="total-neckring" class="total-valor">0</div>
      <div class="total-sub">em todas as máquinas</div>
    </div>
    
    <div class="total-item">
      <div class="total-title"><i class="fas fa-exclamation-circle"></i> Máquinas Críticas</div>
      <div id="total-criticos" class="total-valor">0</div>
      <div class="total-sub">estoque ≤ 3 peças</div>
    </div>
  </div>

  <!-- 
    ====================================================
    SISTEMA DE ABAS
    ====================================================
  -->
  <div class="tabs-container">
    <div class="tabs-header">
      <button class="tab-btn" onclick="openTab('dashboard')">
        <i class="fas fa-chart-line"></i> Dashboard
      </button>
      <button class="tab-btn active" onclick="openTab('controle')">
        <i class="fas fa-cogs"></i> Controle de Produção
      </button>
    </div>
    
    <div id="dashboard" class="tab-content">
      <!-- 
        ====================================================
        GRÁFICOS
        ====================================================
      -->
      <section class="graficos-container">
        <!-- Gráfico de produção atual -->
        <div class="grafico-card">
          <h2><i class="fas fa-chart-bar"></i> Estoque Atual por Máquina</h2>
          <canvas id="graficoProducao"></canvas>
        </div>

        <!-- Gráfico de estoque total (máquina + reserva) -->
        <div class="grafico-card">
          <h2><i class="fas fa-chart-line"></i> Estoque Total (Máquina + Reserva)</h2>
          <canvas id="graficoTotal"></canvas>
        </div>
      </section>
    </div>
    
    <div id="controle" class="tab-content active">
      <!-- 
        ====================================================
        PAINEL DE MÁQUINAS
        ====================================================
      -->
      <h2><i class="fas fa-cogs"></i> Controle por Máquina</h2>
      <div id="painel" class="maquinas-grid"></div>
    </div>
  </div>
</div>

<!-- 
  ====================================================
  SCRIPTS
  ====================================================
-->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
  // ====================================================
  // SISTEMA DE LOGIN
  // ====================================================
  const CORRECT_PASSWORD = "wmoldes";
  const loginScreen = document.getElementById('loginScreen');
  const mainContent = document.getElementById('mainContent');
  const loginForm = document.getElementById('loginForm');
  const passwordInput = document.getElementById('password');
  const errorMessage = document.getElementById('errorMessage');
  const preloader = document.getElementById('preloader');
  
  // Ocultar preloader após 1.5 segundos
  setTimeout(() => {
    preloader.style.opacity = '0';
    setTimeout(() => {
      preloader.style.display = 'none';
    }, 500);
  }, 1500);
  
  loginForm.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const password = passwordInput.value.trim();
    
    if (password === CORRECT_PASSWORD) {
      // Login bem-sucedido
      loginScreen.style.display = 'none';
      mainContent.style.display = 'block';
      mostrarNotificacao("Login realizado com sucesso!", "success");
      // Carregar prefixos após login
      carregarPrefixos();
    } else {
      // Senha incorreta
      errorMessage.style.display = 'block';
      passwordInput.classList.add('error');
      setTimeout(() => {
        passwordInput.classList.remove('error');
      }, 1000);
    }
  });
  
  function logout() {
    loginScreen.style.display = 'block';
    mainContent.style.display = 'none';
    passwordInput.value = '';
    errorMessage.style.display = 'none';
  }

  // ====================================================
  // CONFIGURAÇÃO DO FIREBASE
  // ====================================================
  const firebaseConfig = {
    apiKey: "AIzaSyBPgWEv0f8fK25teN6K2S3VGO63s_YRcOA",
    authDomain: "controleproducao2025-42272.firebaseapp.com",
    databaseURL: "https://controleproducao2025-42272-default-rtdb.firebaseio.com",
    projectId: "controleproducao2025-42272",
    storageBucket: "controleproducao2025-42272.appspot.com",
    messagingSenderId: "524681663678",
    appId: "1:524681663678:web:eb4184a410f1e1893bbaef",
    measurementId: "G-FRB64EYZKB"
  };

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  
  // Dados das máquinas e estoque mínimo
  let dadosMaquinas = {};
  
  // Prefixos pré-definidos com exemplos
  const prefixos = [
    { id: 'LB -0106-S', nome: 'LB -0106-S' },
    { id: 'LB -0271-N1', nome: 'LB -0271-N1' },
    { id: 'LB -0271-SWN', nome: 'LB -0271-SWN' },
    { id: 'LB -0298-TN', nome: 'LB -0298-TN' },
    { id: 'LB -0299-S', nome: 'LB -0299-S' },
    { id: 'LB -0348-N1N', nome: 'LB -0348-N1N' },
    { id: 'LB -0365-N1', nome: 'LB -0365-N1' },
    { id: 'LB -0370-N1', nome: 'LB -0370-N1' },
    { id: 'LB -0379-S', nome: 'LB -0379-S' },
    { id: 'LB -0382-S', nome: 'LB -0382-S' },
    { id: 'LB -0403-S', nome: 'LB -0403-S' },
    { id: 'LB -0415-S', nome: 'LB -0415-S' },
    { id: 'LB -0416-N1', nome: 'LB -0416-N1' },
    { id: 'LB -0420-SX', nome: 'LB -0420-SX' },
    { id: 'LB -0424-N1', nome: 'LB -0424-N1' },
    { id: 'LB -0436-N1', nome: 'LB -0436-N1' },
    { id: 'LB -0441-N1', nome: 'LB -0441-N1' },
    { id: 'LB -0443-N1', nome: 'LB -0443-N1' },
    { id: 'LB -0445-N1', nome: 'LB -0445-N1' },
    { id: 'LB -0449-SX', nome: 'LB -0449-SX' },
    { id: 'LB -0453-S', nome: 'LB -0453-S' },
    { id: 'LB -0457-S', nome: 'LB -0457-S' },
    { id: 'LB -0462-SN', nome: 'LB -0462-SN' },
    { id: 'LB -0471-S', nome: 'LB -0471-S' },
    { id: 'LB -0475-N1', nome: 'LB -0475-N1' },
    { id: 'LB -0477-N1', nome: 'LB -0477-N1' },
    { id: 'LB -0478-N1', nome: 'LB -0478-N1' },
    { id: 'LB -0479-N1', nome: 'LB -0479-N1' },
    { id: 'LB -0481-N1', nome: 'LB -0481-N1' },
    { id: 'LB -0483-S', nome: 'LB -0483-S' },
    { id: 'LB -0484-S', nome: 'LB -0484-S' },
    { id: 'LB -0490-N1', nome: 'LB -0490-N1' },
    { id: 'LB -0491-N1', nome: 'LB -0491-N1' },
    { id: 'LB -0492-N1', nome: 'LB -0492-N1' },
    { id: 'LB -0493-S', nome: 'LB -0493-S' },
    { id: 'LB -0500-N1', nome: 'LB -0500-N1' },
    { id: 'LB -0502-S', nome: 'LB -0502-S' },
    { id: 'LB -0503-N1', nome: 'LB -0503-N1' },
    { id: 'LB -0505-SX', nome: 'LB -0505-SX' },
    { id: 'LB -0506-N1', nome: 'LB -0506-N1' },
    { id: 'LB -0507-N1', nome: 'LB -0507-N1' },
    { id: 'LB -0510-S', nome: 'LB -0510-S' },
    { id: 'LB -0511-S', nome: 'LB -0511-S' },
    { id: 'LB -0512-S', nome: 'LB -0512-S' },
    { id: 'LB -0513-S', nome: 'LB -0513-S' },
    { id: 'LB -0517-N1', nome: 'LB -0517-N1' },
    { id: 'LB -0518-N1', nome: 'LB -0518-N1' },
    { id: 'LB -0518-N1N', nome: 'LB -0518-N1N' },
    { id: 'LB -0519-N1', nome: 'LB -0519-N1' },
    { id: 'LB -0520-N1', nome: 'LB -0520-N1' },
    { id: 'LB -0521-N1', nome: 'LB -0521-N1' },
    { id: 'LB -0522-S', nome: 'LB -0522-S' },
    { id: 'LB -0523-S', nome: 'LB -0523-S' },
    { id: 'LB -0528-N1', nome: 'LB -0528-N1' },
    { id: 'LB -0530-N1', nome: 'LB -0530-N1' },
    { id: 'LB -0534-N1', nome: 'LB -0534-N1' },
    { id: 'LB -0536-N1', nome: 'LB -0536-N1' },
    { id: 'LB -0538-ST', nome: 'LB -0538-ST' },
    { id: 'LB -0539-S', nome: 'LB -0539-S' },
    { id: 'LB -0542-S', nome: 'LB -0542-S' },
    { id: 'LB -0545-S', nome: 'LB -0545-S' },
    { id: 'LB -0546-S', nome: 'LB -0546-S' },
    { id: 'LB -0547-N1', nome: 'LB -0547-N1' },
    { id: 'LB -0552-N1', nome: 'LB -0552-N1' },
    { id: 'LB -0553-S', nome: 'LB -0553-S' },
    { id: 'LB -0554-N1', nome: 'LB -0554-N1' },
    { id: 'LB -0557-N1', nome: 'LB -0557-N1' },
    { id: 'LB -0562-N1', nome: 'LB -0562-N1' },
    { id: 'LB -0567-N1', nome: 'LB -0567-N1' },
    { id: 'LB -0570-S', nome: 'LB -0570-S' },
    { id: 'LB -0571-SX', nome: 'LB -0571-SX' },
    { id: 'LB -0572-S', nome: 'LB -0572-S' },
    { id: 'LB -0573-N1', nome: 'LB -0573-N1' },
    { id: 'LB -0581-S', nome: 'LB -0581-S' },
    { id: 'LB -0582-S', nome: 'LB -0582-S' },
    { id: 'LB -0585-S', nome: 'LB -0585-S' },
    { id: 'LB -0588-S', nome: 'LB -0588-S' },
    { id: 'MB -0100-S', nome: 'MB -0100-S' },
    { id: 'MB -0295-N1', nome: 'MB -0295-N1' },
    { id: 'MB -0468-ST', nome: 'MB -0468-ST' },
    { id: 'MB -0469-S', nome: 'MB -0469-S' },
    { id: 'MB -0469-STW', nome: 'MB -0469-STW' },
    { id: 'MB -0601-SWN', nome: 'MB -0601-SWN' },
    { id: 'MB -0602-SWN', nome: 'MB -0602-SWN' },
    { id: 'MB -0602-SWX', nome: 'MB -0602-SWX' },
    { id: 'MB -0735-SWN', nome: 'MB -0735-SWN' },
    { id: 'MB -0736-SWN', nome: 'MB -0736-SWN' },
    { id: 'MB -0792-N1', nome: 'MB -0792-N1' },
    { id: 'MB -0814-ST', nome: 'MB -0814-ST' },
    { id: 'MB -0831-N1', nome: 'MB -0831-N1' },
    { id: 'MB -0838-N1N', nome: 'MB -0838-N1N' },
    { id: 'MB -0838-N1W', nome: 'MB -0838-N1W' },
    { id: 'MB -0933-S', nome: 'MB -0933-S' },
    { id: 'MB -0966-SWN', nome: 'MB -0966-SWN' },
    { id: 'MB -0967-SWN', nome: 'MB -0967-SWN' },
    { id: 'MB -0969-S', nome: 'MB -0969-S' },
    { id: 'MB -0993-S', nome: 'MB -0993-S' },
    { id: 'MB -1076-N1', nome: 'MB -1076-N1' },
    { id: 'MB -1090-N1N', nome: 'MB -1090-N1N' },
    { id: 'MB -1118-N1', nome: 'MB -1118-N1' },
    { id: 'MB -1137-N1N', nome: 'MB -1137-N1N' },
    { id: 'MB -1159-S', nome: 'MB -1159-S' },
    { id: 'MB -1162-N1', nome: 'MB -1162-N1' },
    { id: 'MB -1165-N1', nome: 'MB -1165-N1' },
    { id: 'MB -1197-N1', nome: 'MB -1197-N1' },
    { id: 'MB -1211-N1', nome: 'MB -1211-N1' },
    { id: 'MB -1228-N1', nome: 'MB -1228-N1' },
    { id: 'MB -1230-N1', nome: 'MB -1230-N1' },
    { id: 'MB -1238-SX', nome: 'MB -1238-SX' },
    { id: 'MB -1260-N1', nome: 'MB -1260-N1' },
    { id: 'MB -1261-N1', nome: 'MB -1261-N1' },
    { id: 'MB -1263-SH', nome: 'MB -1263-SH' },
    { id: 'MB -1264-N1', nome: 'MB -1264-N1' },
    { id: 'MB -1265-N1', nome: 'MB -1265-N1' },
    { id: 'MB -1268-S', nome: 'MB -1268-S' },
    { id: 'MB -1290-N1', nome: 'MB -1290-N1' },
    { id: 'MB -1291-N1', nome: 'MB -1291-N1' },
    { id: 'MB -1297-SN', nome: 'MB -1297-SN' },
    { id: 'MB -1302-S', nome: 'MB -1302-S' },
    { id: 'MB -1306-N1', nome: 'MB -1306-N1' },
    { id: 'MB -1311-S', nome: 'MB -1311-S' },
    { id: 'MB -1313-N1', nome: 'MB -1313-N1' },
    { id: 'MB -1315-S', nome: 'MB -1315-S' },
    { id: 'MB -1319-N1', nome: 'MB -1319-N1' },
    { id: 'MB -1320-N1', nome: 'MB -1320-N1' },
    { id: 'MB -1321-N1', nome: 'MB -1321-N1' },
    { id: 'MB -1322-N1', nome: 'MB -1322-N1' },
    { id: 'MB -1324-N1', nome: 'MB -1324-N1' },
    { id: 'MB -1326-N1', nome: 'MB -1326-N1' },
    { id: 'MB -1327-N1', nome: 'MB -1327-N1' },
    { id: 'MB -1334-N1', nome: 'MB -1334-N1' },
    { id: 'MB -1338-N1N', nome: 'MB -1338-N1N' },
    { id: 'MB -1344-N1X', nome: 'MB -1344-N1X' },
    { id: 'MB -1346-N1', nome: 'MB -1346-N1' },
    { id: 'MB -1347-N1', nome: 'MB -1347-N1' },
    { id: 'MB -1348-SWN', nome: 'MB -1348-SWN' },
    { id: 'MB -1349-SWN', nome: 'MB -1349-SWN' },
    { id: 'MB -1368-N1', nome: 'MB -1368-N1' },
    { id: 'MB -1373-N1', nome: 'MB -1373-N1' },
    { id: 'MB -1375-N1', nome: 'MB -1375-N1' },
    { id: 'MB -1377-N1N', nome: 'MB -1377-N1N' },
    { id: 'MB -1380-S', nome: 'MB -1380-S' },
    { id: 'MB -1381-N1', nome: 'MB -1381-N1' },
    { id: 'MB -1382-N1', nome: 'MB -1382-N1' },
    { id: 'MB -1385-S', nome: 'MB -1385-S' },
    { id: 'MB -1390-N1', nome: 'MB -1390-N1' },
    { id: 'MB -1393-N1', nome: 'MB -1393-N1' },
    { id: 'MB -1396-N1', nome: 'MB -1396-N1' },
    { id: 'MB -1398-S', nome: 'MB -1398-S' },
    { id: 'MB -1399-N1', nome: 'MB -1399-N1' },
    { id: 'MB -1403-N1', nome: 'MB -1403-N1' },
    { id: 'MB -1405-S', nome: 'MB -1405-S' },
    { id: 'MB -1410-S', nome: 'MB -1410-S' },
    { id: 'MB -1413-N1', nome: 'MB -1413-N1' },
    { id: 'MB -1421-S', nome: 'MB -1421-S' },
    { id: 'MB -1435-N1', nome: 'MB -1435-N1' },
    { id: 'MB -1437-N1', nome: 'MB -1437-N1' },
    { id: 'MB -1443-N1X', nome: 'MB -1443-N1X' },
    { id: 'MB -1457-N1', nome: 'MB -1457-N1' },
    { id: 'MB -1461-S', nome: 'MB -1461-S' },
    { id: 'MB -1462-N1', nome: 'MB -1462-N1' },
    { id: 'MB -1470-N1', nome: 'MB -1470-N1' },
    { id: 'MB -1471-N1', nome: 'MB -1471-N1' },
    { id: 'MB -1474-N1', nome: 'MB -1474-N1' },
    { id: 'MB -1476-SX', nome: 'MB -1476-SX' },
    { id: 'MB -1480-N1', nome: 'MB -1480-N1' },
    { id: 'MB -1483-N1', nome: 'MB -1483-N1' },
    { id: 'MB -1488-N1', nome: 'MB -1488-N1' },
    { id: 'MB -1490-N1', nome: 'MB -1490-N1' },
    { id: 'MB -1492-S', nome: 'MB -1492-S' },
    { id: 'MB -1495-N1', nome: 'MB -1495-N1' },
    { id: 'MB -1496-N1', nome: 'MB -1496-N1' },
    { id: 'MB -1497-S', nome: 'MB -1497-S' },
    { id: 'MB -1500-S', nome: 'MB -1500-S' },
    { id: 'MB -1501-N1', nome: 'MB -1501-N1' },
    { id: 'MB -1508-S', nome: 'MB -1508-S' },
    { id: 'MB -1509-SX', nome: 'MB -1509-SX' },
    { id: 'MB -1511-N1', nome: 'MB -1511-N1' },
    { id: 'MB -1512-SN', nome: 'MB -1512-SN' },
    { id: 'MB -1513-S', nome: 'MB -1513-S' },
    { id: 'MB -1514-S', nome: 'MB -1514-S' },
    { id: 'MB -1515-SN', nome: 'MB -1515-SN' },
    { id: 'MB -1518-N1', nome: 'MB -1518-N1' },
    { id: 'MB -1520-S', nome: 'MB -1520-S' },
    { id: 'MB -1527-N1', nome: 'MB -1527-N1' },
    { id: 'MB -1529-S', nome: 'MB -1529-S' },
    { id: 'MB -1530-S', nome: 'MB -1530-S' },
    { id: 'MB -1531-N1', nome: 'MB -1531-N1' },
    { id: 'MB -1533-S', nome: 'MB -1533-S' },
    { id: 'MB -1534-N1', nome: 'MB -1534-N1' },
    { id: 'MB -1535-S', nome: 'MB -1535-S' },
    { id: 'MB -1537-S', nome: 'MB -1537-S' },
    { id: 'MB -1540-SN', nome: 'MB -1540-SN' },
    { id: 'MB -1541-N1', nome: 'MB -1541-N1' },
    { id: 'MB -1544-N1', nome: 'MB -1544-N1' },
    { id: 'MB -1546-S', nome: 'MB -1546-S' },
    { id: 'MB -1548-N1', nome: 'MB -1548-N1' },
    { id: 'MB -1549-S', nome: 'MB -1549-S' },
    { id: 'MB -1550-SX', nome: 'MB -1550-SX' },
    { id: 'MB -1554-N1', nome: 'MB -1554-N1' },
    { id: 'MB -1555-S', nome: 'MB -1555-S' },
    { id: 'MB -1556-S', nome: 'MB -1556-S' },
    { id: 'MB -1558-N1', nome: 'MB -1558-N1' },
    { id: 'MB -1559-N1', nome: 'MB -1559-N1' },
    { id: 'MB -1562-S', nome: 'MB -1562-S' },
    { id: 'MB -1563-S', nome: 'MB -1563-S' },
    { id: 'MB -1564-N1', nome: 'MB -1564-N1' },
    { id: 'MB -1567-S', nome: 'MB -1567-S' },
    { id: 'MB -1568-N1', nome: 'MB -1568-N1' },
    { id: 'MB -1571-N1', nome: 'MB -1571-N1' },
    { id: 'MB -1575-S', nome: 'MB -1575-S' },
    { id: 'MB -1576-S', nome: 'MB -1576-S' },
    { id: 'MB -1579-N1', nome: 'MB -1579-N1' },
    { id: 'MB -1580-N1N', nome: 'MB -1580-N1N' },
    { id: 'MB -1581-N1', nome: 'MB -1581-N1' },
    { id: 'MB -1582-N1', nome: 'MB -1582-N1' },
    { id: 'MB -1583-N1', nome: 'MB -1583-N1' },
    { id: 'MB -1585-S', nome: 'MB -1585-S' },
    { id: 'MB -1587-S', nome: 'MB -1587-S' },
    { id: 'MB -1588-S', nome: 'MB -1588-S' },
    { id: 'MB -1589-S', nome: 'MB -1589-S' },
    { id: 'MB -1591-N1', nome: 'MB -1591-N1' },
    { id: 'MB -1593-S', nome: 'MB -1593-S' },
    { id: 'MB -1594-S', nome: 'MB -1594-S' },
    { id: 'MB -1597-S', nome: 'MB -1597-S' },
    { id: 'MB -1600-S', nome: 'MB -1600-S' },
    { id: 'MB -1601-S', nome: 'MB -1601-S' },
    { id: 'MB -1602-N1', nome: 'MB -1602-N1' },
    { id: 'MB -1603-N1', nome: 'MB -1603-N1' },
    { id: 'MB -1607-S', nome: 'MB -1607-S' },
    { id: 'MB -1609-S', nome: 'MB -1609-S' },
    { id: 'SB -0019-N1D', nome: 'SB -0019-N1D' },
    { id: 'SB -0062-S', nome: 'SB -0062-S' },
    { id: 'SB -0104-N1E', nome: 'SB -0104-N1E' },
    { id: 'SB -0205-N1', nome: 'SB -0205-N1' },
    { id: 'SB -0304-N1', nome: 'SB -0304-N1' },
    { id: 'SB -0407-N1', nome: 'SB -0407-N1' },
    { id: 'SB -0527-N1N', nome: 'SB -0527-N1N' },
    { id: 'SB -0638-SZ', nome: 'SB -0638-SZ' },
    { id: 'SB -0814-S', nome: 'SB -0814-S' },
    { id: 'SB -0814-SX', nome: 'SB -0814-SX' },
    { id: 'SB -0971-SWN', nome: 'SB -0971-SWN' },
    { id: 'SB -1030-SWN', nome: 'SB -1030-SWN' },
    { id: 'SB -1031-SWN', nome: 'SB -1031-SWN' },
    { id: 'SB -1032-SWN', nome: 'SB -1032-SWN' },
    { id: 'SB -1033-SWN', nome: 'SB -1033-SWN' },
    { id: 'SB -1034-SWN', nome: 'SB -1034-SWN' },
    { id: 'SB -1035-SWN', nome: 'SB -1035-SWN' },
    { id: 'SB -1036-SWN', nome: 'SB -1036-SWN' },
    { id: 'SB -1037-SWN', nome: 'SB -1037-SWN' },
    { id: 'SB -1045-S', nome: 'SB -1045-S' },
    { id: 'SB -1270-SWN', nome: 'SB -1270-SWN' },
    { id: 'SB -1271-SWN', nome: 'SB -1271-SWN' },
    { id: 'SB -1272-SWN', nome: 'SB -1272-SWN' },
    { id: 'SB -1272-SX', nome: 'SB -1272-SX' },
    { id: 'SB -1278-SWN', nome: 'SB -1278-SWN' },
    { id: 'SB -1280-SX', nome: 'SB -1280-SX' },
    { id: 'SB -1281-SWN', nome: 'SB -1281-SWN' },
    { id: 'SB -1281-SX', nome: 'SB -1281-SX' },
    { id: 'SB -1289-S', nome: 'SB -1289-S' },
    { id: 'SB -1290-S', nome: 'SB -1290-S' },
    { id: 'SB -1293-S', nome: 'SB -1293-S' },
    { id: 'SB -1303-S', nome: 'SB -1303-S' },
    { id: 'SB -1304-S', nome: 'SB -1304-S' },
    { id: 'SB -1306-S', nome: 'SB -1306-S' },
    { id: 'SB -1338-S', nome: 'SB -1338-S' },
    { id: 'SB -1348-S', nome: 'SB -1348-S' },
    { id: 'SB -1351-S', nome: 'SB -1351-S' },
    { id: 'SB -1352-S', nome: 'SB -1352-S' },
    { id: 'SB -1352-SNW', nome: 'SB -1352-SNW' },
    { id: 'SB -1353-S', nome: 'SB -1353-S' },
    { id: 'SB -1365-N1', nome: 'SB -1365-N1' },
    { id: 'SB -1396-S', nome: 'SB -1396-S' },
    { id: 'SB -1463-S', nome: 'SB -1463-S' },
    { id: 'SB -1471-SN', nome: 'SB -1471-SN' },
    { id: 'SB -1472-SN', nome: 'SB -1472-SN' },
    { id: 'SB -1473-SN', nome: 'SB -1473-SN' },
    { id: 'SB -1475-SN', nome: 'SB -1475-SN' },
    { id: 'SB -1476-SN', nome: 'SB -1476-SN' },
    { id: 'SB -1483-S', nome: 'SB -1483-S' },
    { id: 'SB -1557-S', nome: 'SB -1557-S' },
    { id: 'SB -1564-S', nome: 'SB -1564-S' },
    { id: 'SB -1579-N1N', nome: 'SB -1579-N1N' },
    { id: 'SB -1582-S', nome: 'SB -1582-S' },
    { id: 'SB -1615-N1', nome: 'SB -1615-N1' },
    { id: 'SB -1620-S', nome: 'SB -1620-S' },
    { id: 'SB -1627-N1', nome: 'SB -1627-N1' },
    { id: 'SB -1628-S', nome: 'SB -1628-S' },
    { id: 'SB -1642-N1', nome: 'SB -1642-N1' },
    { id: 'SB -1653-SN', nome: 'SB -1653-SN' },
    { id: 'SB -1659-S', nome: 'SB -1659-S' },
    { id: 'SB -1660-S', nome: 'SB -1660-S' },
    { id: 'SB -1661-S', nome: 'SB -1661-S' },
    { id: 'SB -1666-SN', nome: 'SB -1666-SN' },
    { id: 'SB -1672-S', nome: 'SB -1672-S' },
    { id: 'SB -1675-N1', nome: 'SB -1675-N1' },
    { id: 'SB -1676-N1', nome: 'SB -1676-N1' },
    { id: 'SB -1680-S', nome: 'SB -1680-S' },
    { id: 'SB -1681-S', nome: 'SB -1681-S' },
    { id: 'SB -1685-S', nome: 'SB -1685-S' },
    { id: 'SB -1689-S', nome: 'SB -1689-S' },
    { id: 'SB -1691-S', nome: 'SB -1691-S' },
    { id: 'SB -1695-N1', nome: 'SB -1695-N1' },
    { id: 'SB -1704-S', nome: 'SB -1704-S' },
    { id: 'SB -1704-SB', nome: 'SB -1704-SB' },
    { id: 'SB -1704-SI', nome: 'SB -1704-SI' },
    { id: 'SB -1705-SN', nome: 'SB -1705-SN' },
    { id: 'SB -1707-SN', nome: 'SB -1707-SN' },
    { id: 'SB -1720-S', nome: 'SB -1720-S' },
    { id: 'SB -1721-S', nome: 'SB -1721-S' },
    { id: 'SB -1722-S', nome: 'SB -1722-S' },
    { id: 'SB -1724-N1', nome: 'SB -1724-N1' },
    { id: 'SB -1725-S', nome: 'SB -1725-S' },
    { id: 'SB -1726-S', nome: 'SB -1726-S' },
    { id: 'SB -1727-S', nome: 'SB -1727-S' },
    { id: 'SB -1728-S', nome: 'SB -1728-S' },
    { id: 'SB -1731-S', nome: 'SB -1731-S' },
    { id: 'SB -1734-N1', nome: 'SB -1734-N1' },
    { id: 'SB -1738-N1', nome: 'SB -1738-N1' },
    { id: 'SB -1739-N1', nome: 'SB -1739-N1' },
    { id: 'SB -1741-S', nome: 'SB -1741-S' },
    { id: 'SB -1742-S', nome: 'SB -1742-S' },
    { id: 'SB -1743-S', nome: 'SB -1743-S' },
    { id: 'SB -1747-N1', nome: 'SB -1747-N1' },
    { id: 'SB -1750-N1', nome: 'SB -1750-N1' },
    { id: 'SB -1751-S', nome: 'SB -1751-S' },
    { id: 'SB -1753-S', nome: 'SB -1753-S' },
    { id: 'SB -1754-SX', nome: 'SB -1754-SX' },
    { id: 'SB -1755-N1', nome: 'SB -1755-N1' },
    { id: 'SB -1756-S', nome: 'SB -1756-S' },
    { id: 'SB -1764-S', nome: 'SB -1764-S' },
    { id: 'SB -1768-N1', nome: 'SB -1768-N1' },
    { id: 'SB -1769-N1', nome: 'SB -1769-N1' },
    { id: 'SB -1770-N1', nome: 'SB -1770-N1' }
];
  
  const estoqueMinimo = 3;
  
  // Controle para mostrar apenas máquinas críticas
  let mostrarCriticos = false;
  
  // Estado do modo escuro
  let modoEscuroAtivo = localStorage.getItem('modoEscuro') === 'true';
  
  // Aplicar modo escuro se estiver ativo
  if (modoEscuroAtivo) {
    document.body.classList.add('dark-mode');
    document.querySelector('.dark-mode-toggle').innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
  }

  // ====================================================
  // FUNÇÃO PARA TROCAR DE ABA
  // ====================================================
  function openTab(tabId) {
    // Esconder todas as abas
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => tab.classList.remove('active'));
    
    // Remover classe ativa de todos os botões
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => btn.classList.remove('active'));
    
    // Mostrar aba selecionada
    document.getElementById(tabId).classList.add('active');
    
    // Ativar botão da aba selecionada
    event.currentTarget.classList.add('active');
    
    // Atualizar gráficos se necessário
    if (tabId === 'dashboard' && Object.keys(dadosMaquinas).length > 0) {
      atualizarGrafico(dadosMaquinas);
      atualizarGraficoTotal(dadosMaquinas);
    }
  }

  // ====================================================
  // FUNÇÃO: CRIAR PAINEL DE MÁQUINAS
  // ====================================================
  function criarPainel(maquinas) {
    dadosMaquinas = maquinas;
    const filtro = document.getElementById("filtro").value.toLowerCase();
    const painel = document.getElementById("painel");
    painel.innerHTML = "";
    
    // Inicializar totais
    let totalMolde = 0;
    let totalBlank = 0;
    let totalNeckRing = 0;
    let totalCriticos = 0;

    // Filtrar máquinas (todas ou apenas críticas)
    let maquinasFiltradas = Object.entries(maquinas);
    
    if (mostrarCriticos) {
      maquinasFiltradas = maquinasFiltradas
        .filter(([_, m]) => 
          (m.molde || 0) <= estoqueMinimo || 
          (m.blank || 0) <= estoqueMinimo
        );
    }

    // Ordenar máquinas por ID
    maquinasFiltradas.sort((a, b) => a[0].localeCompare(b[0]));

    // Criar cartão para cada máquina
    for (let [id, m] of maquinasFiltradas) {
      // Pular máquinas que não correspondem ao filtro
      if (filtro && !id.toLowerCase().includes(filtro)) continue;
      
      // Calcular totais
      totalMolde += m.molde || 0;
      totalBlank += m.blank || 0;
      totalNeckRing += m.neck_ring || 0;
      
      // Verificar se a máquina está em estado crítico (apenas para Molde e Blank)
      const alerta = 
        (m.molde || 0) <= estoqueMinimo || 
        (m.blank || 0) <= estoqueMinimo;
      
      if (alerta) totalCriticos++;
      
      // Gerar options para o select de prefixos
      let optionsHTML = '';
      const currentPrefixo = m.prefixo || '';
      
      prefixos.forEach(pref => {
        const selected = pref.id === currentPrefixo ? 'selected' : '';
        optionsHTML += `<option value="${pref.id}" ${selected}>${pref.nome}</option>`;
      });
      
      // Criar o HTML do cartão da máquina com select personalizado
      const maquinaHTML = `
        <div class="maquina ${alerta ? 'alerta' : ''}">
          <div class="maquina-header">
            <div class="maquina-id"><i class="fas fa-industry"></i> Máquina ${id}</div>
            <div class="prefixo-container">
              <div class="custom-select">
                <div class="select-selected" onclick="toggleCustomSelect('${id}')">
                  ${currentPrefixo || 'Selecione um prefixo'}
                </div>
                <div class="select-items" id="select-${id}">
                  <div class="select-search-container">
                    <input type="text" class="select-search" placeholder="Pesquisar prefixo..." 
                           oninput="filtrarOpcoes('${id}', this.value)">
                  </div>
                  ${prefixos.map(pref => `
                    <div onclick="selecionarPrefixo('${id}', '${pref.id}')" 
                         ${pref.id === currentPrefixo ? 'class="selected"' : ''}>
                      ${pref.nome}
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          </div>
          
          <!-- Molde -->
          <div class="linha">
            <span class="molde-label"><i class="fas fa-cube"></i> Molde:</span>
            <div class="controles">
              <div class="btn-group">
                <button class="molde-bg" onclick="alterar('${id}', 'molde', -10)">-10</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde', -5)">-5</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde', -2)">-2</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde', -1)">-1</button>
              </div>
              <span id="${id}-molde">${m.molde || 0}</span>
              <div class="btn-group">
                <button class="molde-bg" onclick="alterar('${id}', 'molde', 1)">+1</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde', 2)">+2</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde', 5)">+5</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde', 10)">+10</button>
              </div>
            </div>
          </div>
          
          <!-- Molde Reserva -->
          <div class="linha reserva">
            <span class="molde-label reserva-label"><i class="fas fa-warehouse"></i> Reserva:</span>
            <div class="controles">
              <div class="btn-group">
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', -10)">-10</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', -5)">-5</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', -2)">-2</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', -1)">-1</button>
              </div>
              <span id="${id}-molde_reserva">${m.molde_reserva || 0}</span>
              <div class="btn-group">
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', 1)">+1</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', 2)">+2</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', 5)">+5</button>
                <button class="molde-bg" onclick="alterar('${id}', 'molde_reserva', 10)">+10</button>
              </div>
            </div>
          </div>
          
          <!-- Blank -->
          <div class="linha">
            <span class="blank-label"><i class="fas fa-cube"></i> Blank:</span>
            <div class="controles">
              <div class="btn-group">
                <button class="blank-bg" onclick="alterar('${id}', 'blank', -10)">-10</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank', -5)">-5</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank', -2)">-2</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank', -1)">-1</button>
              </div>
              <span id="${id}-blank">${m.blank || 0}</span>
              <div class="btn-group">
                <button class="blank-bg" onclick="alterar('${id}', 'blank', 1)">+1</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank', 2)">+2</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank', 5)">+5</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank', 10)">+10</button>
              </div>
            </div>
          </div>
          
          <!-- Blank Reserva -->
          <div class="linha reserva">
            <span class="blank-label reserva-label"><i class="fas fa-warehouse"></i> Reserva:</span>
            <div class="controles">
              <div class="btn-group">
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', -10)">-10</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', -5)">-5</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', -2)">-2</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', -1)">-1</button>
              </div>
              <span id="${id}-blank_reserva">${m.blank_reserva || 0}</span>
              <div class="btn-group">
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', 1)">+1</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', 2)">+2</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', 5)">+5</button>
                <button class="blank-bg" onclick="alterar('${id}', 'blank_reserva', 10)">+10</button>
              </div>
            </div>
          </div>
          
          <!-- Neck Ring -->
          <div class="linha">
            <span class="neckring-label"><i class="fas fa-ring"></i> Neck Ring:</span>
            <div class="controles">
              <div class="btn-group">
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', -10)">-10</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', -5)">-5</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', -2)">-2</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', -1)">-1</button>
              </div>
              <span id="${id}-neck_ring">${m.neck_ring || 0}</span>
              <div class="btn-group">
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', 1)">+1</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', 2)">+2</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', 5)">+5</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring', 10)">+10</button>
              </div>
            </div>
          </div>
          
          <!-- Neck Ring Reserva -->
          <div class="linha reserva">
            <span class="neckring-label reserva-label"><i class="fas fa-warehouse"></i> Reserva:</span>
            <div class="controles">
              <div class="btn-group">
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', -10)">-10</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', -5)">-5</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', -2)">-2</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', -1)">-1</button>
              </div>
              <span id="${id}-neck_ring_reserva">${m.neck_ring_reserva || 0}</span>
              <div class="btn-group">
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', 1)">+1</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', 2)">+2</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', 5)">+5</button>
                <button class="neckring-bg" onclick="alterar('${id}', 'neck_ring_reserva', 10)">+10</button>
              </div>
            </div>
          </div>
          
          <!-- Mensagem de alerta se necessário (apenas para Molde e Blank) -->
          ${alerta ? `
            <div class="alert-message">
              <i class="fas fa-exclamation-triangle"></i> Estoque em nível crítico (≤ ${estoqueMinimo} peças)
            </div>
          ` : ''}
        </div>
      `;
      
      painel.innerHTML += maquinaHTML;
    }

    // Atualizar totais no painel
    document.getElementById("total-molde").textContent = totalMolde;
    document.getElementById("total-blank").textContent = totalBlank;
    document.getElementById("total-neckring").textContent = totalNeckRing;
    document.getElementById("total-criticos").textContent = totalCriticos;
    
    // Atualizar o botão de críticos
    const btn = document.getElementById("btnCriticos");
    btn.innerHTML = mostrarCriticos ? 
      `<i class="fas fa-check-circle"></i> Exibindo Críticos (${totalCriticos})` : 
      `<i class="fas fa-exclamation-triangle"></i> Ver Críticos`;
      
    if (mostrarCriticos) {
      btn.classList.add("criticos");
    } else {
      btn.classList.remove("criticos");
    }
  }

  // ====================================================
  // FUNÇÕES PARA O SELECT PESQUISÁVEL
  // ====================================================
  
  function toggleCustomSelect(maquinaId) {
    const select = document.getElementById(`select-${maquinaId}`);
    const btn = document.querySelector(`#select-${maquinaId}`).previousElementSibling;
    
    // Fechar todos os outros selects abertos
    document.querySelectorAll('.select-items').forEach(el => {
      if (el.id !== `select-${maquinaId}`) {
        el.style.display = 'none';
        el.previousElementSibling.classList.remove('select-arrow-active');
      }
    });
    
    if (select.style.display === 'block') {
      select.style.display = 'none';
      btn.classList.remove('select-arrow-active');
    } else {
      select.style.display = 'block';
      btn.classList.add('select-arrow-active');
    }
  }
  
  function filtrarOpcoes(maquinaId, termo) {
    const select = document.getElementById(`select-${maquinaId}`);
    const itens = select.querySelectorAll('div:not(.select-search-container)');
    
    itens.forEach(item => {
      if (item.textContent.toLowerCase().includes(termo.toLowerCase())) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  }
  
  function selecionarPrefixo(maquinaId, prefixoId) {
    // Atualizar o texto exibido
    const btn = document.querySelector(`#select-${maquinaId}`).previousElementSibling;
    btn.textContent = prefixoId;
    btn.classList.remove('select-arrow-active');
    
    // Fechar o dropdown
    document.getElementById(`select-${maquinaId}`).style.display = 'none';
    
    // Atualizar no banco de dados
    atualizarPrefixo(maquinaId, prefixoId);
  }
  
  // Fechar selects ao clicar fora
  document.addEventListener('click', function(event) {
    if (!event.target.matches('.select-selected') && !event.target.matches('.select-items *')) {
      document.querySelectorAll('.select-items').forEach(el => {
        el.style.display = 'none';
        el.previousElementSibling.classList.remove('select-arrow-active');
      });
    }
  });

  // ====================================================
  // FUNÇÃO: ALTERAR QUANTIDADE DE PEÇAS
  // ====================================================
  function alterar(maquinaId, tipo, delta) {
    const ref = db.ref(`maquinas/${maquinaId}/${tipo}`);
    ref.transaction(current => {
      // Garante que o valor nunca seja negativo
      const newValue = Math.max(0, (current || 0) + delta);
      return newValue;
    });
    
    // Feedback visual
    const element = document.getElementById(`${maquinaId}-${tipo}`);
    if (element) {
      element.classList.remove("highlight");
      void element.offsetWidth; // Trigger reflow
      element.classList.add("highlight");
    }
    
    // Notificação
    const peca = tipo.includes("molde") ? "Molde" : 
                tipo.includes("blank") ? "Blank" : "Neck Ring";
    const acao = delta > 0 ? "adicionada" : "removida";
    mostrarNotificacao(`${Math.abs(delta)} ${peca} ${acao} na máquina ${maquinaId}`);
  }

  // ====================================================
  // FUNÇÃO: ATUALIZAR PREFIXO DA MÁQUINA
  // ====================================================
  function atualizarPrefixo(maquinaId, prefixoId) {
    const ref = db.ref(`maquinas/${maquinaId}/prefixo`);
    ref.set(prefixoId);
    
    mostrarNotificacao(`Prefixo atualizado para: ${prefixoId}`, "info");
  }

  // ====================================================
  // FUNÇÃO: FILTRAR MÁQUINAS
  // ====================================================
  function filtrar() {
    criarPainel(dadosMaquinas);
  }

  // ====================================================
  // FUNÇÃO: ALTERNAR VISUALIZAÇÃO DE CRÍTICOS
  // ====================================================
  function alternarCriticos() {
    mostrarCriticos = !mostrarCriticos;
    criarPainel(dadosMaquinas);
  }

  // ====================================================
  // FUNÇÃO: ALTERNAR MODO ESCURO
  // ====================================================
  function alternarModoEscuro() {
    const body = document.body;
    const btn = document.querySelector('.dark-mode-toggle');
    
    body.classList.toggle('dark-mode');
    modoEscuroAtivo = body.classList.contains('dark-mode');
    
    // Salvar preferência no localStorage
    localStorage.setItem('modoEscuro', modoEscuroAtivo);
    
    // Atualizar texto do botão
    if (modoEscuroAtivo) {
      btn.innerHTML = '<i class="fas fa-sun"></i> Modo Claro';
      mostrarNotificacao("Modo escuro ativado", "info");
    } else {
      btn.innerHTML = '<i class="fas fa-moon"></i> Modo Escuro';
      mostrarNotificacao("Modo claro ativado", "info");
    }
  }

  // ====================================================
  // FUNÇÃO: RECARREGAR DADOS
  // ====================================================
  function recarregarDados() {
    db.ref("maquinas").once("value").then(snapshot => {
      const dados = snapshot.val();
      if (dados) {
        criarPainel(dados);
        atualizarGrafico(dados);
        atualizarGraficoTotal(dados);
        mostrarNotificacao("Dados atualizados com sucesso!", "info");
      }
    });
  }

  // ====================================================
  // FUNÇÃO: MOSTRAR NOTIFICAÇÃO
  // ====================================================
  function mostrarNotificacao(msg, tipo = "success") {
    const toast = document.createElement("div");
    toast.className = `toast ${tipo}`;
    
    let icon = "fas fa-check-circle";
    if (tipo === "error") icon = "fas fa-exclamation-circle";
    if (tipo === "warning") icon = "fas fa-exclamation-triangle";
    if (tipo === "info") icon = "fas fa-info-circle";
    
    toast.innerHTML = `<i class="${icon}"></i> ${msg}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = "fadeout 0.4s forwards";
      setTimeout(() => { toast.remove(); }, 400);
    }, 3000);
  }

  // ====================================================
  // FUNÇÃO: GERAR PDF
  // ====================================================
  async function gerarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    });

    const dataAtual = new Date();
    const dataStr = dataAtual.toLocaleDateString('pt-BR');
    const horaStr = dataAtual.toLocaleTimeString('pt-BR');
    const dataISO = dataAtual.toISOString().split("T")[0];

    // Configurações do relatório
    doc.setFontSize(18);
    doc.setTextColor(30, 41, 59);
    doc.text(`Relatório de Produção - WMoldes`, doc.internal.pageSize.width / 2, 15, { align: "center" });
    
    doc.setFontSize(12);
    doc.setTextColor(100, 116, 139);
    doc.text(`Data: ${dataStr} | Hora: ${horaStr}`, doc.internal.pageSize.width / 2, 22, { align: "center" });

    // Preparar dados para a tabela
    const body = Object.keys(dadosMaquinas).map(id => {
      const m = dadosMaquinas[id];
      
      return [
        id, 
        m.prefixo || 'N/A',
        m.molde || 0,
        m.molde_reserva || 0,
        m.blank || 0,
        m.blank_reserva || 0,
        m.neck_ring || 0,
        m.neck_ring_reserva || 0
      ];
    });

    // Criar tabela no PDF
    doc.autoTable({
      startY: 30,
      head: [
        ['Máquina', 'Prefixo', 'Molde', 'Molde Reserva', 'Blank', 'Blank Reserva', 'Neck Ring', 'Neck Ring Reserva']
      ],
      body: body,
      theme: 'grid',
      headStyles: {
        fillColor: [14, 165, 233],
        textColor: 255,
        fontStyle: 'bold'
      },
      alternateRowStyles: {
        fillColor: [248, 250, 252]
      },
      styles: {
        fontSize: 10,
        cellPadding: 3,
        valign: 'middle'
      },
      columnStyles: {
        0: { cellWidth: 20 },
        1: { cellWidth: 25 },
        2: { cellWidth: 20 },
        3: { cellWidth: 25 },
        4: { cellWidth: 20 },
        5: { cellWidth: 25 },
        6: { cellWidth: 25 },
        7: { cellWidth: 30 }
      }
    });

    // Adicionar rodapé
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
      doc.setPage(i);
      doc.setFontSize(10);
      doc.setTextColor(100, 116, 139);
      doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.width - 20, doc.internal.pageSize.height - 10);
      doc.text(`© WMoldes ${new Date().getFullYear()}`, 20, doc.internal.pageSize.height - 10);
    }

    // Salvar o PDF
    const nomeArquivo = `relatorio_producao_${dataISO}.pdf`;
    doc.save(nomeArquivo);
    
    // Notificar o usuário
    mostrarNotificacao(`PDF gerado: ${nomeArquivo}`, "info");
  }

  // ====================================================
  // FUNÇÃO: ATUALIZAR GRÁFICO DE PRODUÇÃO
  // ====================================================
  function atualizarGrafico(dados) {
    const ctx = document.getElementById("graficoProducao").getContext("2d");
    const maquinas = Object.keys(dados);
    const moldes = maquinas.map(id => dados[id].molde || 0);
    const blanks = maquinas.map(id => dados[id].blank || 0);
    const neckrings = maquinas.map(id => dados[id].neck_ring || 0);

    // Destruir gráfico anterior se existir
    if (window.__graficoProducao) {
      window.__graficoProducao.destroy();
    }

    // Criar novo gráfico
    window.__graficoProducao = new Chart(ctx, {
      type: "bar",
      data: {
        labels: maquinas,
        datasets: [
          {
            label: "Molde",
            data: moldes,
            backgroundColor: "rgba(14, 165, 233, 0.8)",
            borderColor: "rgba(14, 165, 233, 1)",
            borderWidth: 1
          },
          {
            label: "Blank",
            data: blanks,
            backgroundColor: "rgba(12, 74, 110, 0.8)",
            borderColor: "rgba(12, 74, 110, 1)",
            borderWidth: 1
          },
          {
            label: "Neck Ring",
            data: neckrings,
            backgroundColor: "rgba(79, 70, 229, 0.8)",
            borderColor: "rgba(79, 70, 229, 1)",
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: "top",
            labels: {
              font: {
                size: 14
              }
            }
          },
          title: {
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(30, 41, 59, 0.9)',
            titleFont: {
              size: 14
            },
            bodyFont: {
              size: 13
            },
            padding: 10
          },
          datalabels: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 12
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              font: {
                size: 12
              }
            },
            title: {
              display: true,
              text: 'Quantidade',
              font: {
                size: 13,
                weight: 'bold'
              }
            }
          }
        },
        animation: {
          duration: 800,
          easing: 'easeOutQuart'
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  // ====================================================
  // FUNÇÃO: ATUALIZAR GRÁFICO DE ESTOQUE TOTAL
  // ====================================================
  function atualizarGraficoTotal(dados) {
    const ctx = document.getElementById("graficoTotal").getContext("2d");
    const maquinas = Object.keys(dados);
    
    // Calcular totais (máquina + reserva)
    const moldesTotal = maquinas.map(id => 
      (dados[id].molde || 0) + (dados[id].molde_reserva || 0)
    );
    
    const blanksTotal = maquinas.map(id => 
      (dados[id].blank || 0) + (dados[id].blank_reserva || 0)
    );
    
    const neckringsTotal = maquinas.map(id => 
      (dados[id].neck_ring || 0) + (dados[id].neck_ring_reserva || 0)
    );

    // Destruir gráfico anterior se existir
    if (window.__graficoTotal) {
      window.__graficoTotal.destroy();
    }

    // Criar novo gráfico
    window.__graficoTotal = new Chart(ctx, {
      type: "bar",
      data: {
        labels: maquinas,
        datasets: [
          {
            label: "Molde Total",
            data: moldesTotal,
            backgroundColor: "rgba(14, 165, 233, 0.6)",
            borderColor: "rgba(14, 165, 233, 1)",
            borderWidth: 1
          },
          {
            label: "Blank Total",
            data: blanksTotal,
            backgroundColor: "rgba(12, 74, 110, 0.6)",
            borderColor: "rgba(12, 74, 110, 1)",
            borderWidth: 1
          },
          {
            label: "Neck Ring Total",
            data: neckringsTotal,
            backgroundColor: "rgba(79, 70, 229, 0.6)",
            borderColor: "rgba(79, 70, 229, 1)",
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: "top",
            labels: {
              font: {
                size: 14
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(30, 41, 59, 0.9)',
            titleFont: {
              size: 14
            },
            bodyFont: {
              size: 13
            },
            padding: 10
          },
          datalabels: {
            display: false
          }
        },
        scales: {
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: {
                size: 12
              }
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              font: {
                size: 12
              }
            },
            title: {
              display: true,
              text: 'Quantidade Total',
              font: {
                size: 13,
                weight: 'bold'
              }
            }
          }
        },
        animation: {
          duration: 800,
          easing: 'easeOutQuart'
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  // ====================================================
  // INICIALIZAÇÃO E LISTENERS DO FIREBASE
  // ====================================================
  
  // Listener para atualizar dados quando houver mudanças no Firebase
  db.ref("maquinas").on("value", async snapshot => {
    const dados = snapshot.val();
    if (dados) {
      criarPainel(dados);
      atualizarGrafico(dados);
      atualizarGraficoTotal(dados);
    } else {
      mostrarNotificacao("Nenhum dado encontrado no banco de dados", "warning");
    }
  });

  // Função placeholder para carregar prefixos
  function carregarPrefixos() {
    mostrarNotificacao("Prefixos carregados", "info");
  }

  // Inicializar gráficos com dados vazios
  window.addEventListener('DOMContentLoaded', () => {
    atualizarGrafico({});
    atualizarGraficoTotal({});
  });
</script>
</body>
</html>
